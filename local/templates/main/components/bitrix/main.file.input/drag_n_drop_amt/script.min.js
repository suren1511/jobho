(function(){if(window.BlogBFileDialog){return}window.BlogBFileDialogUniqueID=[];window.BlogBFileDialog=function(a){this.dialogName="AttachmentsDialog";this.agent=false;this.uploadFileUrl=a.upload_path;this.id=(!!a.id?a.id:this.getID());this.controlID=a.id;this.enabled=true;this.controller=(!!a.controller)?a.controller:null;this.fileInput=a.fileInput;a.hAttachEvents=BX.delegate(this.InitAgent,this);this.msg=a.msg;this.dropAutoUpload=a.dropAutoUpload;this.CID=a.CID;this.multiple=!!a.multiple;a.caller=this;a.classes={uploaderParent:"file-uploader",uploader:"file-fileUploader",tpl_simple:"file-simple",tpl_extended:"file-extended",selector:"file-selector",selector_active:"file-selector-active"};a.doc_prefix="wd-doc";a.placeholder=BX.findChild(this.controller,{className:"file-placeholder-tbody"},true);this.doc_prefix=a.doc_prefix;this.values=(a.values||[]);if(!!BX.FileUploadAgent){this.agent=new BX.FileUploadAgent(a);BX.addCustomEvent(this,"ShowUploadedFile",BX.delegate(this.ShowUploadedFile,this));BX.addCustomEvent(this,"StopUpload",BX.delegate(this.StopUpload,this));BX.onCustomEvent(BX(this.controller.parentNode),"BFileDLoadFormControllerInit",[this])}else{BX.debug("/bitrix/components/bitrix/main.file.input/templates/drag_n_drop/script.js: BX.FileUploadAgent is not defined. You need to load /bitrix/js/main/file_upload_agent.js")}};window.BlogBFileDialog.prototype.getID=function(){return""+new Date().getTime()};window.BlogBFileDialog.prototype.InitAgent=function(a){if(this.controller){a.placeholder=BX.findChild(this.controller,{className:"file-placeholder-tbody"},true)}};window.BlogBFileDialog.prototype.ShowUploadedFile=function(b){this.agent=b;var a=b.uploadResult;if(a&&(a.element_id>0)){if(!!b.inputName&&b.inputName.length>0){var c=BX.create("INPUT",{props:{id:"file-doc"+a.element_id,type:"hidden",name:b.inputName+(this.multiple?"[]":""),value:a.element_id}});b.controller.appendChild(c)}this.values.push(this.CreateFileRow(a));b._clearPlace();if(this.controller&&this.controller.parentNode){BX.onCustomEvent(this.controller.parentNode,"OnFileUploadSuccess",[a,this])}}else{var d=(a&&a.error?a.error:this.msg.upload_error);b.ShowUploadError(d);if(this.controller&&this.controller.parentNode){BX.onCustomEvent(this.controller.parentNode,"OnFileUploadFail")}}};window.BlogBFileDialog.prototype.CreateFileRow=function(a){var d=a;var g="file";if(!!d.element_content_type&&(d.element_content_type.indexOf("image/")==0)&&!!d.element_image&&(d.element_image.length>0)&&!!d.element_thumbnail&&(d.element_thumbnail.length>0)){g="image"}var b=BX("file-"+g+"-template");BX.template(b,BX.delegate(function(h){this.tplFileRow(h,d)},this));var c=BX.clone(b);if(g=="image"){var e=null;for(i=0;i<c.children.length;i++){e=c.children[i];if(e.nodeType==1){break}}e.setAttribute("id",this.doc_prefix+a.element_id);var f=BX.findChild(e,{className:"feed-add-post-del-but"},true);BX.bind(f,"click",BX.delegate(function(){var k=f;var h=k.parentNode;this.agent.StopUpload(h);BX.cleanNode(h,true)},this));this.agent.AddNodeToPlaceholder(e);c=e}else{c.setAttribute("id",this.doc_prefix+a.element_id);this.agent.AddRowToPlaceholder(c)}return c};window.BlogBFileDialog.prototype.GetUploadDialog=function(a){return new BlogBFileDialogUploader(this,a)};window.BlogBFileDialog.prototype.tplFileRow=function(a,b){for(id in a){if(!a.hasOwnProperty(id)){continue}var c=a[id];if((id=="image")&&!!b.element_image&&(b.element_image.length>0)&&!!b.element_thumbnail&&(b.element_thumbnail.length>0)){c.setAttribute("src",b.element_image);c.setAttribute("rel",b.element_thumbnail)}else{if(!!b["element_"+id]){c.innerHTML=b["element_"+id]}}}};window.BlogBFileDialog.prototype._addUrlParam=function(a,b){if(!a){return null}if(a.indexOf(b)==-1){a+=((a.indexOf("?")==-1)?"?":"&")+b}return a};window.BlogBFileDialog.prototype.LoadDialogs=function(a){if(!!this.agent){this.agent.LoadDialogs(a)}else{var b=a;setTimeout(BX.delegate(function(){this.LoadDialogs(b)},this),100)}};window.BlogBFileDialog.prototype.StopUpload=function(b,a){this.agent=b;id=false;mID=a.id.match(new RegExp(this.doc_prefix+"(\\d+)"));if(!!mID){id=mID[1]}if(this.controller&&this.controller.parentNode){BX.onCustomEvent(this.controller.parentNode,"OnFileUploadRemove",[id,this])}var c={fileID:id,sessid:BX.bitrix_sessid(),cid:this.CID,controlID:this.controlID,mfi_mode:"delete"};BX.ajax.post(this.uploadFileUrl,c)};window.BlogBFileDialogDispatcher=function(a){this.id=this.getID();this.controller=a;BX.loadScript("/bitrix/js/main/core/core_dd.js",BX.delegate(function(){if(BX.type.isElementNode(this.controller)&&this.controller.parentNode&&this.controller.parentNode.parentNode){var b=this.controller.parentNode.parentNode;this.dropbox=new BX.DD.dropFiles(b);if(this.dropbox&&this.dropbox.supported()&&BX.ajax.FormData.isSupported()){this.hExpandUploader=BX.proxy(this.ExpandUploader,this);BX.addCustomEvent(this.dropbox,"dragEnter",this.hExpandUploader);BX.addCustomEvent(b,"UnbindDndDispatcher",BX.delegate(this.Unbind,this))}}},this))};window.BlogBFileDialogDispatcher.prototype.getID=function(){return""+new Date().getTime()};window.BlogBFileDialogDispatcher.prototype.ExpandUploader=function(){BX.onCustomEvent(BX(this.controller.parentNode),"BFileDLoadFormController",["show"])};window.BlogBFileDialogDispatcher.prototype.Unbind=function(){BX.removeCustomEvent(this.dropbox,"dragEnter",this.hExpandUploader)};window.BlogBFileDialogUploader=function(b,a){this.WDUploaded=false;this.WDUploadInProgress=false;this.documentExists=false;this.fileDropped=false;this.caller=b;this.agent=a;this.parentID=this.agent.id;this.id=this.caller.getID();this.msg=b.msg;this.dropAutoUpload=b.dropAutoUpload;this.uploadFileUrl=b.uploadFileUrl;this.CID=b.CID;this.controlID=b.controlID;this.CreateElements();this.fileInput=(!!a.fileInput?a.fileInput:((BX.type.isDomNode(a.fileInputID))?a.fileInputID:BX(b.fileInput)));if(BX.type.isDomNode(this.fileInput)){this.fileInput.name="mfi_files[]"}this.fileList=this.__form;BX.loadScript("/bitrix/js/main/core/core_dd.js",BX.delegate(function(){var c=new BX.DD.dropFiles();if(c&&c.supported()&&BX.ajax.FormData.isSupported()){this.dropbox=c}this.agent.BindUploadEvents(this)},this))};window.BlogBFileDialogUploader.prototype.CreateElements=function(){var d;do{d=Math.floor(Math.random()*99999)}while(BX("iframe-"+d));var c="iframe-"+this.id;var a=BX.create("IFRAME",{props:{name:c,id:c},style:{display:"none"}});document.body.appendChild(a);this.iframeUpload=a;var b=BX.create("FORM",{props:{id:"form-"+d,method:"POST",action:this.uploadFileUrl,enctype:"multipart/form-data",encoding:"multipart/form-data",target:c},style:{display:"none"},children:[BX.create("INPUT",{props:{type:"hidden",name:"sessid",value:BX.bitrix_sessid()}}),BX.create("INPUT",{props:{type:"hidden",name:"uniqueID",value:d}}),BX.create("INPUT",{props:{type:"hidden",name:"cid",value:this.CID}}),BX.create("INPUT",{props:{type:"hidden",name:"controlID",value:(!!this.controlID?this.controlID:"")}}),BX.create("INPUT",{props:{type:"hidden",name:"mfi_mode",value:"upload"}})]});document.body.appendChild(b);this.__form=b;window["FILE_UPLOADER_CALLBACK_"+d]=BX.proxy(this.Callback,this)};window.BlogBFileDialogUploader.prototype.GetUploadFileName=function(){var b="";if(this.fileInput&&(this.fileInput.value.length>0)){var b=this.fileInput.value;if(b.indexOf("\\")>-1){b=b.substr(b.lastIndexOf("\\")+1)}}else{var a=this.fileList;if(a.file){b=a.file.fileName||a.file.name}}return b};window.BlogBFileDialogUploader.prototype.Callback=function(c,d){if(c.length>0){for(var b=0;b<c.length;b++){var a={};a.success=true;a.storage="bfile";a.element_id=c[b].fileID;a.element_name=c[b].fileName;a.element_size=c[b].fileSize;a.element_url=c[b].fileURL;a.element_content_type=(c[b].content_type?c[b].content_type:c[b].fileContentType);a.element_image=((!!c[b].img_thumb_src)?c[b].img_thumb_src:c[b].fileSrc);if(!!a.element_image){a.element_image=a.element_image.replace(/\/([^\/]+)$/,function(f,e){return"/"+BX.util.urlencode(e)})}a.element_thumbnail=((!!c[b].img_source_src)?c[b].img_source_src:c[b].fileSrc);if(!!a.element_thumbnail){a.element_thumbnail=a.element_thumbnail.replace(/\/([^\/]+)$/,function(f,e){return"/"+BX.util.urlencode(e)})}if(c[b]["error"]){a.error=c[b]["error"]}BX.onCustomEvent(this,"uploadFinish",[a])}}else{var a={};a.success=false;a.messages=this.msg.upload_error;BX.onCustomEvent(this,"uploadFinish",[a])}window["FILE_UPLOADER_CALLBACK_"+d]=BX.DoNothing;BX.cleanNode(BX("iframe-"+d),true);BX.cleanNode(BX("form-"+d),true);this.agent.uploadDialog=null};window.BlogBFileDialogUploader.prototype.UploadResponse=function(a,b){this.WDUploadInProgress=false;BX.unbind(window,"beforeunload",BX.proxy(this.UploadLeave,this));if(!b||b.length<=0){this.onError()}};window.BlogBFileDialogUploader.prototype.UploadResponseIframe=function(a,b){this.WDUploadInProgress=false;BX.unbind(window,"beforeunload",BX.proxy(this.UploadLeave,this))};window.BlogBFileDialogUploader.prototype.UploadLeave=function(a){var a=a||window.event;var b="";if(this.WDUploadInProgress){b=this.msg.UploadInterrupt}else{if(((!this.WDUploaded)&&this.fileInput&&(this.fileInput.value.length>0))){b=this.msg.UploadNotDone}}if(b!=""){if(a){a.returnValue=b}return b}return};window.BlogBFileDialogUploader.prototype.UpdateListFiles=function(b){if(this&&b){if(b.length<1){return}var a=this.fileList;a.file=b[0];this.WDUploadInProgress=true;this.fileDropped=true;this.CallSubmit()}};window.BlogBFileDialogUploader.prototype.GetInputData=function(a){var f=[];var e={};f=f.concat(BX.findChildren(a,{tag:"input"},true),BX.findChildren(a,{tag:"textarea"},true),BX.findChildren(a,{tag:"select"},true));for(var c=0;c<f.length;c++){var d=f[c];if(!d||d.disabled||d.name.length<1){continue}switch(d.type.toLowerCase()){case"text":case"textarea":case"password":case"hidden":case"select-one":e[d.name]=d.value;break;case"radio":if(d.checked){e[d.name]=d.value}break;case"checkbox":e[d.name]=(d.checked?"Y":"N");break;case"select-multiple":var b=d.options.length;if(b>0){e[d.name]=new Array()}for(j=0;j<b;j++){if(d.options[j].selected){e[d.name].push(d.options[j].value)}}break;default:break}}return e};window.BlogBFileDialogUploader.prototype.SetFileInput=function(a){if(!!this.__form.mfi_save){return}if(this.fileInput&&this.fileInput!=a){BX.remove(this.fileInput)}this.__form.appendChild(a);this.fileInput=a};window.BlogBFileDialogUploader.prototype.CallSubmit=function(){if(!!this.__form.mfi_save){return}BX.onCustomEvent(this,"uploadStart",[this]);BX.bind(window,"beforeunload",BX.proxy(this.UploadLeave,this));BX.bind(this.iframeUpload,"load",BX.delegate(this.UploadResponseIframe,this));if(this.dropbox){this.onProgress(0.15);if(this.fileInput&&(this.fileInput.files.length>0)){var c=this.fileList;c.file=this.fileInput.files[0]}var d=this.GetInputData(this.__form);this.fileNodes=[this.fileList];for(i in this.fileNodes){if(this.fileNodes[i].file){var f=new BX.ajax.FormData();for(item in this.fileNodes[i].data){f.append(item,this.fileNodes[i].data[item])}if(!!Object&&!!Object.keys){var g=Object.keys(d);for(var b in g){var e=g[b];var a=d[e];f.append(e,a)}}else{for(item in d){f.append(item,d[item])}}f.append("mfi_files[]",this.fileNodes[i].file);f.send(this.uploadFileUrl,BX.delegate(function(k){this.UploadResponse(null,k)},this),BX.delegate(this.onProgress,this))}}}else{this.onProgress(0.15);this.WDUploadInProgress=true;var h=this.__form.id;BX.submit(this.__form,"mfi_save","Y")}};window.BlogBFileDialogUploader.prototype.onProgress=function(a){if(isNaN(a)){return}BX.onCustomEvent(this,"progress",[a])};window.BlogBFileDialogUploader.prototype.onError=function(){BX.onCustomEvent(this,"uploadFinish",[{success:false,messages:this.msg.upload_error}])};top.BlogBFileDialog=window.BlogBFileDialog;top.BlogBFileDialogUploader=window.BlogBFileDialogUploader;top.BlogBFileDialogDispatcher=window.BlogBFileDialogDispatcher;window.MFIDD=function(e){BX.loadCSS("/bitrix/components/bitrix/main.file.input/templates/drag_n_drop/style.css");var c=(e.status==="show"?"show":(e.status==="hide"?"hide":"switch"));if(c=="switch"){c=(e.controller.style.display!="none"?"hide":"show")}var b=function(f){if(f=="show"){BX.fx.show(e.controller,"fade",{time:0.2});if(e.switcher&&e.switcher.style.display!="none"){BX.fx.hide(e.switcher,"fade",{time:0.1})}if(!!window["BfileUnbindDispatcher"+e.uid]){window["BfileUnbindDispatcher"+e.uid]()}}else{if(e.controller.style.display!=="none"){BX.fx.hide(e.controller,"fade",{time:0.2})}}};if(!e.controller.loaded){e.controller.loaded=true;var a=new BX.DD.dropFiles(),d=(a&&a.supported()&&BX.ajax.FormData.isSupported()?"extended":"simple");top["BfileFD"+e.uid]=window["BfileFD"+e.uid]=new BlogBFileDialog({mode:d,CID:e.CID,id:e.id,upload_path:e.upload_path,multiple:e.multiple,controller:e.controller,inputName:e.inputName,fileInput:("file-fileUploader-"+e.uid),fileInputName:"mfi_files[]",values:BX.findChildren(BX("file-selectdialog-"+e.uid),{className:"file-inline-file"},true),msg:{loading:BX.message("loading"),file_exists:BX.message("file_exists"),upload_error:BX.message("upload_error"),access_denied:BX.message("access_denied")}});b(c);window["BfileFD"+e.uid].LoadDialogs("DropInterface");BX.onCustomEvent("BFileDSelectFileDialogLoaded",[window["BfileFD"+e.uid]])}else{b(c)}};window.BlogBFileJustDialog=function(a){this.dialogName="AttachmentsDialog";this.agent=false;this.id=(!!a.id?a.id:this.getID());this.controlID=a.id;this.enabled=true;this.uploadFileUrl=a.upload_path;this.controller=(!!a.controller)?a.controller:null;this.CID=a.CID;a.caller=this;a.doc_prefix="wd-doc";a._mkFileInput=BX.DoNothing;a.mode="extended";a.classes={tpl_simple:"file-simple",tpl_extended:"file-extended"};this.doc_prefix=a.doc_prefix;if(!!BX.FileUploadAgent){this.agent=new BX.FileUploadAgent(a);BX.addCustomEvent(this,"StopUpload",BX.delegate(this.StopUpload,this));BX.onCustomEvent(BX(this.controller.parentNode),"BFileDLoadFormControllerInit",[this])}else{BX.debug("/bitrix/components/bitrix/main.file.input/templates/drag_n_drop/script.js: BX.FileUploadAgent is not defined. You need to load /bitrix/js/main/file_upload_agent.js")}};window.BlogBFileJustDialog.prototype.StopUpload=function(b,a){this.agent=b;id=false;mID=a.id.match(new RegExp(this.doc_prefix+"(\\d+)"));if(!!mID){id=mID[1]}if(this.controller&&this.controller.parentNode){BX.onCustomEvent(this.controller.parentNode,"OnFileUploadRemove",[id,this])}var c={fileID:id,sessid:BX.bitrix_sessid(),cid:this.CID,controlID:this.controlID,mfi_mode:"delete"};BX.ajax.post(this.uploadFileUrl,c)};window.MFIS=function(a){if(!a.controller.loaded){a.controller.loaded=true;top["BfileFD"+a.uid]=window["BfileFD"+a.uid]=new BlogBFileJustDialog({CID:a.CID,id:a.id,upload_path:a.upload_path,controller:a.controller,values:BX.findChildren(BX("file-selectdialog-"+a.uid),{className:"file-inline-file"},true)});BX.fx.show(a.controller,"fade",{time:0.2});BX.onCustomEvent("BFileDSelectFileDialogLoaded",[window["BfileFD"+a.uid]])}}})(window);